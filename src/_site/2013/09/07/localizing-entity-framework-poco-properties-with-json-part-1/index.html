<!DOCTYPE html>
<html lang="en">
<head itemscope itemref="http://schema.org/Blog">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Localizing Entity Framework POCO Properties with JSON - Part 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" itemprop="author" content="Andy Mehalick">
  <meta name="copyright" itemprop="copyrightHolder" content="Andy Mehalick">
  <meta name="description" itemprop="description" content="It’s day #1 on a new project demanding my favorite requirement: localization yay! The yay emphasize is mine because localization presents some thorny technic...">
  <meta itemprop="name" content="Localizing Entity Framework POCO Properties with JSON - Part 1">
  <meta itemprop="image" content="">
  <meta property="og:title" content="Localizing Entity Framework POCO Properties with JSON - Part 1">
  <meta property="og:type" content="blog">
  <meta property="og:url" content="https://andy.mehalick.com/2013/09/07/localizing-entity-framework-poco-properties-with-json-part-1/">
  <meta property="og:image" content="">
  <meta property="og:site_name" content="Andy Mehalick">
  <meta property="og:description" content="It’s day #1 on a new project demanding my favorite requirement: localization yay! The yay emphasize is mine because localization presents some thorny technical challenges that often pull along a trailer load of complexity. Framework tools make many of the localization tasks a breeze but there’s always that one piece just beyond .NET’s reach: storing localized text in a database. Since I’ve spent far too many hours (days?) wrestling with lookup table and lookup tables for lookup table solutions it’s time to start this project off with a simple and elegant solution – one that plays nice with Entity Framework and maybe even brings its own UI to the party.">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Atomic+Age:400|Muli:400,700">
  <link rel="canonical" href="https://andy.mehalick.com/2013/09/07/localizing-entity-framework-poco-properties-with-json-part-1/">
  <link rel="alternate" type="application/rss+xml" title="Andy Mehalick" href="http://feeds.feedburner.com/AndyMehalick">
  <link rel="me" type="text/html" href="https://plus.google.com/113902592100905338618">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <script>
    if (document.location.host === "andy.mehalick.com") {
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments);
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g;
            m.parentNode.insertBefore(a, m);
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-28045940-1', 'auto');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');
    }
  </script>
</head>

<body>  
    <nav>
        <div class="page-width">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>        
            <a id="rss" href="http://feeds.feedburner.com/AndyMehalick" title="Subscribe to RSS">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28"><style>.st0{fill:#F78C28;} .st1{fill:#FFFFFF;}</style><path class="st0" d="M0 0h28v28H0z"/><g><path class="st1" d="M18.2 9.8C14.4 6 9.4 3.9 4 3.9v4c4.3 0 8.4 1.7 11.4 4.7s4.7 7.1 4.7 11.4h4c0-5.4-2.1-10.4-5.9-14.2z"/><path class="st1" d="M3.9 10.6v4c5.2 0 9.5 4.2 9.5 9.5h4c0-7.5-6.1-13.5-13.5-13.5z"/><circle class="st1" cx="6.7" cy="21.3" r="2.8"/></g></svg> 
            </a>
            <div class="clearfix"></div>
        </div>
    </nav>  
    <main class="page-width">
        <div class="padded">
            <div id="site-photo">
                <img src="https://andy.azureedge.net/assets/andy-mehalick-v1-280x280-635783259977684363.jpg" alt="Andy Mehalick" width="140" height="140" />
            </div>
            <header id="site-header">
                <h1>Andy Mehalick</h1>
                <h2>Software Architect, Engineer, UX Designer</h2>
                <hr />
            </header>
            <div id="content">               
                <article class="blog-post">
    <header>
        <h1>Localizing Entity Framework POCO Properties with JSON - Part 1</h1>
        <h2><time datetime="2013-09-07 00:00:00 +0300" pubdate>7 September 2013</time></h2>
    </header>
    <p>It’s day #1 on a new project demanding my favorite requirement: localization yay! The yay emphasize is mine because localization presents some thorny technical challenges that often pull along a trailer load of complexity. Framework tools make many of the localization tasks a breeze but there’s always that one piece just beyond .NET’s reach: storing localized text in a database. Since I’ve spent far too many hours (days?) wrestling with lookup table and lookup tables for lookup table solutions it’s time to start this project off with a simple and elegant solution – one that plays nice with Entity Framework and maybe even brings its own UI to the party.</p>

<p>My requirements are simple: I’m using EF code first and will need to store entities having multilanguage properties… and I want to work with a super-simple, elegant, unobtrusive API that reads like poetry. Spoiler alert — we’re bringing JSON to the party along with my new favorite NuGet package (ok dislaimer I wrote it).</p>

<p><img src="https://andy.azureedge.net/blog/localized-property-636217948871506770.jpg" alt="" /></p>

<p>Let’s jump in — this tutorial will ditch the too-popular generic lookup table approach and store localized text for entities as key/value serialized JSON. Our JSON is simple, readable, and searchable. We’ll then use some simple extension methods from the NuGet package <a href="https://www.nuget.org/packages/OrangeJetpack.Localization">OrangeJetpack.Localization</a> to make getting and setting our localized text a breeze.</p>

<p>To peak ahead just a bit we’ll be using a regular EF POCO model and code-first migrations. We’ll work with an entity <strong>Planet</strong> having a <strong>PlanetId</strong> and a <strong>Name</strong> property that will eventually be localized to English, Russian, and Japanese. Ultimately it will look like this in our database:</p>

<p><img src="https://andy.azureedge.net/blog/8-28-2013-8-54-38-pm-636217948862861091.png" alt="" /></p>

<h2 id="setup">Setup</h2>

<p>To start things off new-up a fresh ASP.NET MVC web application. You can play along at home or download a working demo at: <a href="https://github.com/andy-mehalick/OrangeJetpack.LocalizationDemo">https://github.com/andy-mehalick/OrangeJetpack.LocalizationDemo</a>. Next we’ll add our simple EF POCO and DbContext classes:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Planet</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nf">DatabaseGenerated</span><span class="p">(</span><span class="n">DatabaseGeneratedOption</span><span class="p">.</span><span class="n">Identity</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">PlanetId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PlanetsContext</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">planet</span><span class="p">&gt;</span> <span class="n">Planets</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We’ll then let code first migrations create our local db with some Powershell in Package Manager Console:</p>

<pre class="cmd">PM&gt; Enable-Migrations</pre>

<pre class="cmd">PM&gt; Add-Migrations AddPlanet</pre>

<pre class="cmd">PM&gt; Update-Database</pre>

<p>Finally, let’s add a HomeController with Index() and scaffold a list view.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">PlanetsContext</span> <span class="n">_db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PlanetsContext</span><span class="p">();</span>

    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">planets</span> <span class="p">=</span> <span class="n">_db</span><span class="p">.</span><span class="n">Planets</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">planets</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Snap your fingers to add some sample data and you should see:</p>

<p><img src="https://andy.azureedge.net/blog/8-28-2013-7-36-35-pm-636217948851575515.png" alt="" /></p>

<p>Eesh, close but let’s now show the localized content only.</p>

<h2 id="nuget-and-orangejetpacklocalizationmvc">NuGet and OrangeJetpack.Localization.Mvc</h2>

<p>Start by added the NuGet package <a href="https://www.nuget.org/packages/OrangeJetpack.Localization.Mvc">OrangeJetpack.Localization.Mvc</a> (it will drag its dependency <a href="https://www.nuget.org/packages/OrangeJetpack.Localization">OrangeJetpack.Localization</a> along with it):</p>

<pre class="cmd">PM&gt; Install-Package OrangeJetpack.Localization.Mvc</pre>

<p>This package will add a LocalizationLanguages property to app settings, let’s add the language codes for English, Russian, and Japanese:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;appSettings&gt;</span>
        <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"LocalizationLanguages"</span> <span class="na">value=</span><span class="s">"en,ru,ja"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/appSettings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre></figure>

<p>Finally, let’s update Planet to indicate it is localizable and that Planet.Name is localized – we can do this by implementing ILocalizable and decorating Name with LocalizedAttribute:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Planet</span> <span class="p">:</span> <span class="n">ILocalizable</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="nf">DatabaseGenerated</span><span class="p">(</span><span class="n">DatabaseGeneratedOption</span><span class="p">.</span><span class="n">Identity</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">PlanetId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">Required</span><span class="p">,</span> <span class="n">Localized</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This now generously grants us access to an IEnumerable<ilocalizeable>.Localize() extension method. This method accepts a language code and a list of properties to localize.</ilocalizeable></p>

<p>Back to HomeController.Index(), add an optional langCode input parameter and change _db.Planets.ToList() to _db.Planets.Localize(langCode, I =&gt; i.Name):</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">PlanetsContext</span> <span class="n">_db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PlanetsContext</span><span class="p">();</span>

    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">(</span><span class="kt">string</span> <span class="n">langCode</span> <span class="p">=</span> <span class="s">"en"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">var</span> <span class="n">planets</span> <span class="p">=</span> <span class="n">_db</span><span class="p">.</span><span class="n">Planets</span><span class="p">.</span><span class="nf">Localize</span><span class="p">(</span><span class="n">langCode</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">planets</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Of course we could get language code from the user’s web browser or a profile setting but let’s keep it simple for now. If we omit a language code or use an unsupported one it will default to the first language in our app settings, “en” by default. Let’s run it again passing in the language code for Russian:</p>

<p><img src="https://andy.azureedge.net/blog/8-28-2013-7-59-35-pm-636217948858550811.png" alt="" /></p>

<p>Here’s what it would look like with no language, Japanese, or an unknown language:</p>

<p><img src="https://andy.azureedge.net/blog/8-28-2013-8-54-38-pm-636217948862861091.png" alt="" /></p>

<h2 id="multiple-localized-properties">Multiple Localized Properties</h2>

<p>Finally, one bonus of our extension method Localize() is its support for multiple properties; if Planet had additional localized properties we could pass them in as a params[] list:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">_db</span><span class="p">.</span><span class="n">Planets</span><span class="p">.</span><span class="nf">Localize</span><span class="p">(</span><span class="n">langCode</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">Atmosphere</span><span class="p">);</span></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>That’s it for now, in Part 2 we’ll look at adding and updating our localizable entities with the included editor template for MVC and eventually we’ll dig deeper in OrangeJetpack.Localization implementation. If you want to jump ahead you can find the project at <a href="https://github.com/andy-mehalick/OrangeJetpack.Localization">https://github.com/andy-mehalick/OrangeJetpack.Localization</a>.</p>

</article>

<div id="disqus_thread"></div>

<script>
    if (document.location.host === "andy.mehalick.com") {
        var disqus_identifier = "7";
        var disqus_title = "Localizing Entity Framework POCO Properties with JSON - Part 1";
        (function () {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//andymehalick.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    }
</script>
           
            </div>       
        </div>
    </main> 
    <footer>
        <div class="page-width">
            Site content and theme by <a rel="author" href="https://plus.google.com/113902592100905338618">Andy Mehalick</a> | Built with <a href="http://jekyllrb.com/">Jekyll</a> on <a href="http://azure.microsoft.com/en-us/">Microsoft Azure</a>
        </div>
    </footer>
</body>
</html>
